<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Ext.ux.BlankField Demo</title>
	<link rel="stylesheet" type="text/css" href="../res/js/ext2/resources/css/ext-all.css" />
	<link rel="stylesheet" type="text/css" href="../res/js/ext2/resources/css/patch.css" />
	<link rel="stylesheet" type="text/css" href="../res/css/runTime.css" />
	
	<style>
	/*for Ext.ux.Portal.js*/
	.x-portal .x-panel-dd-spacer {
		margin-bottom:10px;
	}

	.x-portlet {
		margin-bottom:10px;
	}

	/* Clean up the look of the portlets */
	.x-portlet .x-panel-ml {
		padding-left:2px;
	}
	.x-portlet .x-panel-mr {
		padding-right:2px;
	}
	.x-portlet .x-panel-bl {
		padding-left:2px;
	}

	.x-portlet .x-panel-br {
		padding-right:2px;
	}
	.x-portlet .x-panel-body {
		background:white;
	}
	.x-portlet .x-panel-mc {
		padding-top:2px;
	}
	.x-portlet .x-panel-bc .x-panel-footer {
		padding-bottom:2px;
	}
	.x-portlet .x-panel-nofooter .x-panel-bc {
		height:2px;
	}
	</style>
	
 	<script type="text/javascript" src="../res/js/ext2/adapter/ext/ext-base.js"></script>
	<script type="text/javascript" src="../res/js/ext2/ext-all-debug.js"></script>	
	<script type="text/javascript" src="../res/js/ext2/ext-lang-zh_CN.js"></script>
	<script type="text/javascript" src="../res/js/ext_base_extension.js"></script>
	<script type="text/javascript" src="../res/js/controls/Ext.ux.Portal.js"></script>
	<script type="text/javascript" src="../res/js/html5_upload_purity.js"></script>
	<script type="text/javascript">
/*
*空白控件
*说明：该控件只是一个容器，根据配置生成界面
*author:cici
*date:2012/11/8
*依赖：
*/

Ext.ux.BlankField = function (config) {	
	var controlsCfg = config.items;
	if(typeof controlsCfg==="string"){
		try{
			config.items = Ext.decode(controlsCfg);
		}catch(ex){
			Ext.msg.alert("控件的配置出错");
		}
	}
	Ext.ux.BlankField.superclass.constructor.call(this, config);
}
Ext.extend(Ext.ux.BlankField, Ext.form.Field, {
	/****/
	childConfig:null,
	initComponent: function () {
		Ext.applyDeep(this,this.initialConfig);
		this.autoCreate = { tag: 'input', type: 'hidden', name: this.initialConfig.name || "" };
		Ext.ux.BlankField.superclass.initComponent.call(this);
	},
	onRender:function(ct,pos){
		Ext.ux.BlankField.superclass.onRender.call(this,ct,pos);	
		var childConfig = Ext.isArray(this.items)?this.items:[this.items];	
		
		var itemCfg = Ext.applyDeep({},this.initialConfig);
		delete itemCfg.id;delete itemCfg.name;delete itemCfg.fieldLabel;
		
		this.itemsPanel = new Ext.Panel(itemCfg);
		this.itemsPanel.render(ct);
		this.itemsPanel.field = this;
	},	
	setValue:function(v){
		Ext.ux.BlankField.superclass.setValue.call(this,v);
	}
});
Ext.reg('blankfield', Ext.ux.BlankField);


</script>
</head>
<body>
<script>
Ext.onReady(function(){
	Ext.BLANK_IMAGE_URL = "../res/js/ext2/resources/images/default/s.gif";
	Ext.lOADING_IMAGE_URL= "../res/js/ext2/resources/images/default/grid/wait.gif"; //resources\images\default\grid
	Ext.QuickTips.init();
	Ext.form.Field.prototype.msgTarget = 'qtip';
	
	
	new Ext.Viewport({
		layout:"fit",
		items:[{
			xtype:"form",
			layout:"xform",
			autoHeight:true,
			items:[{
				xtype:'blankfield',
				name:'myblankfield',
				fieldLabel:'幻灯片',
				id:"blankfield_1",
				//height:250,
				//width:500,
				border:false,
				//layout:"form",
				value:'{"description":["泰国情欲大作《晚娘上部：恋欲》12日主要演员马力欧、西野翔、NEW来台宣传电影，而这部片也因有AV女优西野翔的加持格外备受关注，她昨在记者会上开口用十分标准的中文向大家问好，事后透露\u201c全是小空(苍井空)教的！\u201d对于片中不少的性爱床戏，西野翔也很大方，直言\u201c其实裸露就是我的专业。\u201d","日本知名AV女优西野翔这回加入《晚娘上部：恋欲》演出，她为戏苦学泰文，被外界关注有望追寻前辈苍井空的脚步转型成演员。片中她有不少令人脸红心跳的激情性爱场景，西野翔昨透露进剧组的第一场戏就是SM的场面，她直言\u201c接这部片的时候其实就有(拍性爱戏)觉悟，且裸露本来就是我的专业，所以拍摄时就是要丢弃所谓的害羞。\u201d","只是接拍大银幕电影，是否有意追随苍井空脚步淡出AV界？西野翔笑称\u201c其实这次来台湾前，就是同公司的小空(苍井空)教了我很多中文。\u201d不过她认为若能向苍井空这样当然很好，但也强调\u201c若有工作需要我露，我还是会做。","泰国帅哥偶像马力欧因主演《爱在暹罗》深受台湾粉丝喜爱，外型俊俏的他，表示是以专业态度演出片中床戏，不会有尴尬的生理反应。","西野翔cos play图。","西野翔生活照。","西野翔清纯照。","西野翔cos play照。","西野翔可爱生活照。","西野翔可爱生活照。","西野翔。","","","","",""],"path":["http://s4.mimg.ifeng.com/upload/day_121114/201211141104402961.jpg","http://s2.mimg.ifeng.com/upload/day_121114/201211141104401974.jpg","http://s0.mimg.ifeng.com/upload/day_121114/201211141104417782.jpg","http://s1.mimg.ifeng.com/upload/day_121114/201211141104417087.jpg","http://s1.mimg.ifeng.com/upload/day_121114/201211141104405238.jpg","http://s2.mimg.ifeng.com/upload/day_121114/201211141104411878.jpg","http://s4.mimg.ifeng.com/upload/day_121114/201211141104418542.jpg","http://s2.mimg.ifeng.com/upload/day_121114/201211141104429339.jpg","http://s2.mimg.ifeng.com/upload/day_121114/201211141104424793.jpg","http://s3.mimg.ifeng.com/upload/day_121114/201211141104426322.jpg","http://s0.mimg.ifeng.com/upload/day_121114/201211141104414019.jpg","http://s2.mimg.ifeng.com/upload/day_121114/201211141104428027.jpg","http://s0.mimg.ifeng.com/upload/day_121114/201211141104437394.jpg","http://s0.mimg.ifeng.com/upload/day_121114/201211141104439288.jpg","http://s2.mimg.ifeng.com/upload/day_121114/201211141104438762.jpg","http://s0.mimg.ifeng.com/upload/day_121114/201211141104435014.jpg"]}',
				items:[{
					xtype:'button',
					text:"图集编辑器",
					handler:function(){
						var field = this.ownerCt.field;
						var value = field.getValue();
											
						if(!field.editorWin){
							var itemTpl = new Ext.XTemplate('<span style="width:100%;height:100%"><div style="float:left;width:200px;height:170px;background:url(../res/img/loading3.gif) no-repeat center center;"><a title="点击查看原图"  href="{url}" target="_blank"><img width="200" height="170" src="{url}"/></a></div><textarea style="font-size:12px;width:330px;height:158px;margin:3px;">{summary}</textarea></span>');
						
							if(value){	
								
								var slide=[];
								var origData = Ext.decode(value);
								var des = origData.description;
								var path = origData.path;
								for(var i=0;i<path.length;i++){
									slide.push({
										"url":path[i],
										"summary":des[i]||""
									});
								}
								var tools = [{
									id:'close',
									handler: function(e, target, panel){
										panel.ownerCt.remove(panel, true);
									}
								}];
								
								var items=[];
								for(var i=0;i<slide.length;i++){
									var it = slide[i];
									items.push({
										title: (i+1),
										tools:tools,
										html:itemTpl.applyTemplate(it)
									});
								}
							}
								
							var win = new Ext.Window({
								title:"幻灯中的图片(支持拖拽排序)",
								width:600,
								height:600,
								autoScroll:true,
								layout:"fit",
								buttonAlign:"center",
								closeAction:'hide',
								maximizable:true,
								items:[{
									xtype:'portal',
									region:'center',
									margins:'35 5 5 0',
									items:[{
										columnWidth:1,
										style:'padding:10px 10px 10px 10px',
										items:items||null
									}],
									listeners:{
										"drop":function(){
											//更新序号
											var items = arguments[0].portal.items.items[0].items;
											for(var i=0;i<items.length;i++){
												var p = items.itemAt(i);
												p && p.setTitle(i+1);
											}
										}
									}
								}],
								bbar:[{
									xtype:'tbfill'
								}/*,{
									xtype:'panel',
									border:false,
									frame:true,
									bodyStyle:'padding-left: 18px; background: url("../res/img/topnewedit/icon_add.png") no-repeat scroll 0px -19px transparent;',
									html:'添加图片<input  type="file" style="position: absolute;opacity: 0;cursor: pointer;top: 0;left:-25px;z-index: 100;" size="30" name="fileselect[]" multiple>'
								}*/,{
									text:"添加图片",
									//style:'background: url("../res/img/topnewedit/icon_add.png") no-repeat scroll 0px -19px transparent;',
									scope:field,
									cls:'btnAdd',
									handler:function(){
										field.editorWin.body.child("input[type=file]").dom.click();
									}
								}],
								html:'<input  type="file" style="position: absolute;opacity: 0;cursor: pointer;top: 0;left:-25px;z-index: 100;" size="30" name="fileselect[]" multiple>',
								listeners:{
									'show':function(win){
										var fileInputEl = win.body.child("input[type=file]");
										var portal = win.items.items[0];
										if(!portal.setPortalItemData){
											portal.setPortalItemData = function(p,data){
												var img = p.body.child("img");
												var textarea = p.body.child("textarea");
												var link = p.body.child("a");
												img.dom.src = data.url||"";
												textarea.dom.value = data.summary||"";
												link.dom.href = data.url||"#";
											};
										}
										
										!fileInputEl.hasChangeEvent && fileInputEl.on("change",function(evt){
											//阻止默认事件
											evt.stopPropagation();
											evt.preventDefault();
											//搜集文件
											var files = evt.target.files||[];
											var arrFiles=[];
											for(var i = 0, iLen = files.length; i< iLen; i++)
											{
												var file = files[i];
												if (file.type.indexOf("image") == 0) {
													if (file.size >= 1024000) {
														Ext.Msg.alert('您这张"'+ file.name +'"图片大小过大('+ (file.size/1000) +'k)，应小于1024k');	
													} else {
														arrFiles.push({file:file});	
													}			
												} else {
													Ext.Msg.alert('文件"' + file.name + '"不是图片。');	
												}
											}
											
											//在图片portal上预览
											
											var length = portal.items.items[0].items.length;
											
											win.files = arrFiles;
											var appendImage = function(index){
												var win = this;
												var currentIndex = index;
												return function(){
													if(win.files.length<=currentIndex) {
														//开始上传
														for (var i = 0, fileJson; fileJson = win.files[i]; i++) {
															console.log("正在上传" + i);
															(function(fileJson) {
																var file = fileJson.file;
																var xhr = new XMLHttpRequest();
																if (xhr.upload) {
																	// 上传中
																	xhr.upload.addEventListener("progress", function(e) {
																		//self.onProgress(file, e.loaded, e.total);
																	}, false);
														
																	// 文件上传成功或是失败
																	xhr.onreadystatechange = function(e) {
																		if (xhr.readyState == 4) {
																			if (xhr.status == 200) {
																				//成功 xhr.responseText
																				var ret = Ext.decode(xhr.responseText);
																				if(ret.success){
																					var url = ret.message;
																					portal.setPortalItemData(fileJson.portlet,{url:url});
																				}
																			} else {
																				console.log("失败");
																			}
																		}
																	};
																	// 开始上传
																	xhr.open("POST", "../runtime/upload!file.jhtml", true);
																	//使用FormData处理需要上传的数据
																	var oParam={
																		domain:"y1.ifengimg.com",
																		syncflag:1,//同步
																		filedataFileName:file.name
																	}
																	var fd = new FormData();
																	for( var j in oParam) {
																		fd.append(j,oParam[j]);
																	}
																	fd.append("filedata", file);
																	xhr.send(fd);
																}	
															})(fileJson);	
														}
														
														return;
													}
													var p = portal.items.itemAt(0).add({
														title: "图片" + (portal.items.itemAt(0).items.length+1),
														tools:tools,
														html:win.portletTpl.applyTemplate({url:"",summary:''})
													});
													win.files[currentIndex].portlet = p;
													portal.doLayout();
													portal.body.dom.scrollTop = portal.body.dom.scrollHeight;
													appendImage.call(win,currentIndex+1)();
													
												}
											}
											appendImage.call(win,0)();
											
										},win);
										fileInputEl.hasChangeEvent = true;
									}
								},
								buttons:[{
									text:"确定",
									handler:function(){
										var portal = this.ownerCt.items.items[0];
										if(!portal.getPortalItemData){
											portal.getPortalItemData = function(p){
												var img = p.body.child("img");
												var textarea = p.body.child("textarea");
												return {
													url:img.dom.src,
													summary:textarea.dom.value
												};
											};
										}
										//搜集数据
										
										var items = portal.items.items[0].items;
										var dataJson = {description:[],path:[]};
										for(var i=0;i<items.length;i++){
											var p = items.itemAt(i);
											var itemData = portal.getPortalItemData(p);
											dataJson.description.push(itemData.summary);
											dataJson.path.push(itemData.url);
										}
										var field = this.ownerCt.field;
										field.setValue(Ext.encode(dataJson));
										this.ownerCt.hide();
									}
								},{
									text:"关闭",
									handler:function(){
										this.ownerCt.hide();
									}
								}]
							});
							win.portletTpl = itemTpl;
							field.editorWin = win;
							field.editorWin.field = field;
						}
						field.editorWin.show();
						//field.editorWin.setHeight(Ext.getDoc().getHeight());
						field.editorWin.center();
					}
				}]
			}]
		}]
	});
});
	
</script>
</body>
</html>